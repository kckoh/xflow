{{- if .Values.opensearch.enabled }}
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: opensearch
  labels:
    app: opensearch
    {{- include "xflow.labels" . | nindent 4 }}
spec:
  serviceName: opensearch
  replicas: {{ .Values.opensearch.replicas | default 1 }}
  selector:
    matchLabels:
      app: opensearch
  template:
    metadata:
      labels:
        app: opensearch
        {{- include "xflow.selectorLabels" . | nindent 8 }}
    spec:
      securityContext:
        fsGroup: 1000
        runAsUser: 1000
      initContainers:
        - name: fix-permissions
          image: busybox:1.36
          command:
            - sh
            - -c
            - |
              chown -R 1000:1000 /usr/share/opensearch/data
          securityContext:
            runAsUser: 0
          volumeMounts:
            - name: opensearch-data
              mountPath: /usr/share/opensearch/data
        {{- if .Values.opensearch.plugins }}
        - name: install-plugins
          image: "{{ .Values.opensearch.image.repository }}:{{ .Values.opensearch.image.tag }}"
          command:
            - sh
            - -c
            - |
              {{- range .Values.opensearch.plugins }}
              if ! /usr/share/opensearch/bin/opensearch-plugin list | grep -q {{ . }}; then
                /usr/share/opensearch/bin/opensearch-plugin install --batch {{ . }}
              fi
              {{- end }}
              cp -r /usr/share/opensearch/plugins/* /plugins/ 2>/dev/null || true
          volumeMounts:
            - name: plugins
              mountPath: /plugins
        {{- end }}
      containers:
        - name: opensearch
          image: "{{ .Values.opensearch.image.repository }}:{{ .Values.opensearch.image.tag }}"
          ports:
            - containerPort: 9200
              name: http
            - containerPort: 9600
              name: transport
          env:
            - name: discovery.type
              value: single-node
            - name: plugins.security.disabled
              value: {{ not .Values.opensearch.security.enabled | quote }}
            - name: OPENSEARCH_JAVA_OPTS
              value: {{ .Values.opensearch.javaOpts | quote }}
          volumeMounts:
            - name: opensearch-data
              mountPath: /usr/share/opensearch/data
            {{- if .Values.opensearch.plugins }}
            - name: plugins
              mountPath: /usr/share/opensearch/plugins
            {{- end }}
          resources:
            {{- toYaml .Values.opensearch.resources | nindent 12 }}
          readinessProbe:
            httpGet:
              path: /_cluster/health
              port: 9200
            initialDelaySeconds: 30
            periodSeconds: 10
          livenessProbe:
            httpGet:
              path: /_cluster/health
              port: 9200
            initialDelaySeconds: 60
            periodSeconds: 20
      volumes:
        {{- if .Values.opensearch.persistence.enabled }}
        - name: opensearch-data
          persistentVolumeClaim:
            claimName: opensearch-pvc
        {{- else }}
        - name: opensearch-data
          emptyDir: {}
        {{- end }}
        {{- if .Values.opensearch.plugins }}
        - name: plugins
          emptyDir: {}
        {{- end }}
{{- end }}
